<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title><%= title %></title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/css/composer.css">
</head>
<body class="composer-dark">
  <div class="composer-backdrop"></div>

  <header class="composer-topbar">
    <div class="brand">Spread It ‚Äî Composer</div>
    <div class="top-actions">
      <button id="toggleChat" class="btn-small">Chat AI</button>
    </div>
  </header>

  <main class="composer-stage chat-mode">
    <!-- Chat Interface (Central) -->
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="message ai">
                <div class="avatar">ü§ñ</div>
                <div class="bubble">
                    Bonjour ! Je suis votre assistant Spread It. <br>
                    √âcrivez-moi simplement votre id√©e de post, ou collez un texte brut. Je vais l'analyser, l'optimiser pour chaque r√©seau social et vous proposer les meilleures versions.
                </div>
            </div>
            
            <!-- Cards will be injected here dynamically by AI -->
        </div>

        <div class="chat-input-area">
            <textarea id="userPrompt" class="chat-textarea" placeholder="Ex: R√©dige un post sur le lancement de la nouvelle collection..." rows="1"></textarea>
            <button id="sendMessage" class="btn-send">Envoyer ‚û§</button>
        </div>
    </div>

    <!-- Hidden Container for generated cards (moved into chat stream logically) -->
    <div id="hidden-structure" style="display:none;">
    <!-- Original editor structure kept for logic binding but hidden -->
      <div class="cards-stack" id="cardsStack">
        <div class="post-card top-card card-1" id="activeCard">
          <div class="card-body">
            <div id="postEditor" class="editor" contenteditable="true"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Platform cards template for Chat Injection -->
  <template id="platformCardsTemplate">
    <div class="platform-grid">
    <% const platforms = ['facebook','instagram','twitter','linkedin','tiktok']; %>
    <% platforms.forEach(function(p){ %>
      <article class="platform-wrapper mini-card" data-platform="<%= p %>">
        <div class="platform-header">
            <span class="p-icon <%= p %>"></span> 
            <span class="p-name"><%= p.charAt(0).toUpperCase()+p.slice(1) %></span>
        </div>
        <div class="social-preview theme-dark p-<%= p %>" style="<%= (!configured[p]) ? 'opacity:0.75; filter:grayscale(1);' : '' %>">
            <div class="sp-body">
               <div class="sp-text-preview" contenteditable="true">...</div>
            </div>
            <% if(p === 'tiktok') { %>
               <div class="tiktok-overlay-lite">
                   <div class="tk-desc">Legende TikTok...</div>
               </div>
            <% } %>
        </div>
        <div class="mini-actions">
           <button class="btn-xs ghost action-copy" onclick="copyToClipboard(this)">Copier</button>
        </div>
      </article>
    <% }); %>
    </div>
  </template>

  <!-- REPLACED OLD SCRIPT WITH CHAT LOGIC -->
  <script>
    // Pass server-side config to client
    const USER_CONFIG = JSON.parse('<%- JSON.stringify(configured || {}) %>');
    
    // Auto-resize textarea
    const tx = document.getElementById('userPrompt');
    tx.addEventListener("input", function(){
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Simple script to handle Chat logic -> UI
    document.getElementById('sendMessage').addEventListener('click', () => handleSend());
    tx.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // --- AUTO-DETECT PREFILLED CONTENT (Video / Media) ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const prefill = params.get('prefill');
        const videoUrl = params.get('video_url');
        const posterUrl = params.get('poster');
        const title = params.get('title');
        const description = params.get('description');
        
        // Store poster globally for previews
        if(posterUrl) window.CURRENT_POSTER = posterUrl;

        if(prefill && videoUrl) {
            // Show a "System" message indicating detection with THUMBNAIL if available
            let visualHtml = `üé• M√©dia d√©tect√© : <strong>${title || 'Vid√©o'}</strong>`;
            if(posterUrl) {
                visualHtml += `<br><img src="${posterUrl}" style="max-width:100px; border-radius:8px; margin-top:8px; display:block;" alt="Thumbnail">`;
            }
            visualHtml += `<br><span style="font-size:0.9em; opacity:0.8">Je pr√©pare une strat√©gie de diffusion...</span>`;
            
            addMessage('ai', visualHtml);
            
            // Auto-trigger generation with richer context
            let prompt = `Je veux partager cette vid√©o : "${title || 'Nouvelle vid√©o'}".\nLien: ${videoUrl}\n`;
            if(description) prompt += `Contexte/Description: "${description}"\n`;
            prompt += `G√©n√®re des posts engageants pour mes r√©seaux en utilisant la technique du Newsjacking. Utilise l'image fournie comme visuel si n√©cessaire.`;
            
            handleSend(prompt);
        }
        
        if (params.get('platforms')) {
           // Handle platform selection updates if needed
        }
    });

    async function handleSend(forcedText = null){
        const input = document.getElementById('userPrompt');
        let txt = forcedText || input.value.trim();
        
        if(!txt) return;

        // User Message
        if (!forcedText) {
            addMessage('user', txt);
            input.value = '';
            input.style.height = 'auto';
        } else {
             // For auto-trigger, we don't necessarily need to echo the huge prompt back
             // just a small confirmation or nothing if the system msg covers it
        }

        // AI Loading State
        const loadingId = addMessage('ai', '<span class="typing-dots">Analyse de la tendance actuelle...</span>');

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: txt,
                    // Send contextual info if needed
                    platforms: Object.keys(USER_CONFIG)
                })
            });

            if(!response.ok) throw new Error("Erreur r√©seau");

            const data = await response.json(); // Expecting { reply, cards }
            
            // 1. Update text reply
            document.querySelector(`#${loadingId} .bubble`).innerHTML = data.reply || "Voici les r√©sultats :";
            
            // 2. Inject Cards if present
            if (data.cards && Object.keys(data.cards).length > 0) {
                const template = document.getElementById('platformCardsTemplate');
                const clone = template.content.cloneNode(true);
                
                // Update each card in the clone
                clone.querySelectorAll('.platform-wrapper').forEach(card => {
                    const platform = card.dataset.platform;
                    const content = data.cards[platform];
                    const isConfigured = USER_CONFIG[platform];

                    const previewEl = card.querySelector('.sp-text-preview');
                    const copyBtn = card.querySelector('.action-copy');

                    if (!isConfigured) {
                        // NOT AUTHENTICATED
                        card.classList.add('locked'); // Add visual style for locked
                        previewEl.innerText = "Connexion requise pour voir le contenu optimis√©.";
                        previewEl.style.opacity = "0.5";
                        previewEl.style.fontStyle = "italic";
                        // Change copy button to connect button
                        copyBtn.innerText = "Se connecter";
                        copyBtn.classList.remove('ghost');
                        copyBtn.classList.add('accent');
                        copyBtn.onclick = () => window.open(`/auth/${platform}/login`, '_blank');
                    } else if (content) {
                        // AUTHENTICATED & HAS CONTENT
                        previewEl.innerText = content;
                        
                        // Apply Image Background from Metadata if available
                         if(window.CURRENT_POSTER) {
                            const bodyEl = card.querySelector('.sp-body');
                            if(bodyEl) {
                                bodyEl.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.7)), url('${window.CURRENT_POSTER}')`;
                                bodyEl.style.backgroundSize = 'cover';
                                bodyEl.style.backgroundPosition = 'center';
                                previewEl.style.textShadow = '0 1px 3px rgba(0,0,0,0.8)';
                            }
                        }
                    } else {
                        // NO CONTENT GENERATED
                        previewEl.innerText = "Pas de contenu g√©n√©r√© pour ce r√©seau.";
                    }
                });
                
                const msgContainer = document.getElementById(loadingId);
                msgContainer.appendChild(clone);
            }
            
            // Scroll
            const container = document.getElementById('chatMessages');
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });

        } catch (e) {
            document.querySelector(`#${loadingId} .bubble`).innerHTML = "D√©sol√©, une erreur est survenue : " + e.message;
        }
    }

    function addMessage(type, html) {
        const id = 'msg-' + Date.now();
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.id = id;
        div.innerHTML = `
            ${type === 'ai' ? '<div class="avatar">ü§ñ</div>' : ''}
            <div class="bubble">${html}</div>
        `;
        document.getElementById('chatMessages').appendChild(div);
        return id;
    }
    
    function copyToClipboard(btn) {
        // ... (Logic handled inline for simplicity or separated)
        // Note: The click handler in the template calls this, but we overrode it in JS for logic
    }
  </script>

