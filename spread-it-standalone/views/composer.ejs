<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title><%= title %></title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/css/composer.css">
</head>
<body class="composer-dark">
  <div class="composer-backdrop"></div>

  <header class="composer-topbar">
    <div class="brand">Spread It ‚Äî Composer</div>
    <div class="top-actions">
      <button id="toggleChat" class="btn-small">Chat AI</button>
    </div>
  </header>


<!-- LOAD FONTS & ICONS FOR MOCKUPS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* SPLIT VIEW LAYOUT */
.composer-split-view {
    display: flex;
    height: 100vh;
    padding-top: 60px; /* Topbar height */
    overflow: hidden;
    background: #000;
}

/* LEFT: CHAT SIDEBAR */
.chat-sidebar {
    width: 320px;
    flex-shrink: 0;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    background: #111;
}
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.chat-input-area {
    padding: 15px;
    background: #1a1a1a;
    border-top: 1px solid #333;
}
.message { font-size: 14px; line-height: 1.4; color: #eee; }
.message.ai .bubble { background: #222; padding: 10px; border-radius: 8px; border-left: 3px solid #3b82f6; }
.message.user { align-self: flex-end; }
.message.user .bubble { background: #3b82f6; color: white; padding: 8px 12px; border-radius: 12px 12px 0 12px; }

/* RIGHT: PREVIEW DECK */
.preview-deck {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    background: #050505;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 30px;
    align-content: start;
}

/* REALISTIC SOCIAL CARDS */
.mockup-card {
    background: #000;
    border: 1px solid #333;
    border-radius: 12px;
    overflow: hidden;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

/* Status Overlay */
.account-status-overlay {
    background: rgba(220, 38, 38, 0.9);
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    display: none; /* hidden by default */
}
.mockup-card.disconnected .account-status-overlay { display: block; }
.mockup-card.disconnected .mockup-content { opacity: 0.3; pointer-events: none; }

/* Facebook Style */
.facebook-style { background: #242526; border-color: #3e4042; }
.facebook-style .header { padding: 12px; display: flex; align-items: center; gap: 10px; }
.facebook-style .avatar { width: 40px; height: 40px; border-radius: 50%; background: #444; }
.facebook-style .meta { flex: 1; }
.facebook-style .name { font-weight: 600; font-size: 15px; display: block; }
.facebook-style .time { font-size: 12px; color: #b0b3b8; }
.facebook-style .body { padding: 0 12px 12px; font-size: 15px; color: #e4e6eb; white-space: pre-wrap; outline: none; }
.facebook-style .media-area { background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.facebook-style .media-area img, .facebook-style .media-area video { max-width: 100%; max-height: 400px; }
.facebook-style .footer { padding: 12px; border-top: 1px solid #3e4042; display: flex; justify-content: space-around; color: #b0b3b8; font-weight: 600; font-size: 14px; }

/* Instagram Style */
.instagram-style { background: #000; border: 1px solid #262626; }
.instagram-style .header { padding: 14px; display: flex; align-items: center; gap: 10px; }
.instagram-style .avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #f09433, #e6683c); padding: 2px; }
.instagram-style .name { font-weight: 600; font-size: 14px; color: #fff; }
.instagram-style .media-area { aspect-ratio: 4/5; background: #111; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
.instagram-style .media-area img, .instagram-style .media-area video { width: 100%; height: 100%; object-fit: cover; }
.instagram-style .actions { padding: 12px; display: flex; gap: 16px; font-size: 24px; }
.instagram-style .caption-area { padding: 0 12px 15px; font-size: 14px; }
.instagram-style .caption-body { color: #f5f5f5; outline: none; }

/* LinkedIn Style */
.linkedin-style { background: #1b1f23; border-color: #333; }
.linkedin-style .header { padding: 12px; display: flex; gap: 10px; }
.linkedin-style .avatar { width: 48px; height: 48px; background: #444; }
.linkedin-style .name { font-weight: 600; font-size: 14px; color: #fff; }
.linkedin-style .body { padding: 8px 12px; font-size: 14px; color: #e1e9ee; outline: none; }
.linkedin-style .footer { padding: 12px; border-top: 1px solid #333; display: flex; justify-content: space-around; color: #fff; font-size: 14px; }

/* Twitter Style */
.twitter-style { background: #000; border-color: #2f3336; }
.twitter-style .header { padding: 12px 16px 0; display: flex; gap: 12px; }
.twitter-style .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; }
.twitter-style .name-row { display: flex; gap: 5px; font-size: 15px; }
.twitter-style .handle { color: #71767b; }
.twitter-style .body { padding: 0 16px; margin-top: -20px; margin-left: 64px; margin-bottom: 10px; font-size: 15px; color: #e7e9ea; outline: none; }
.twitter-style .media-container { margin-left: 64px; margin-right: 16px; border-radius: 16px; border: 1px solid #2f3336; overflow: hidden; }
.twitter-style .media-container img, .twitter-style .media-container video { width: 100%; max-height: 300px; object-fit: cover; display: block; }
.twitter-style .footer { margin-left: 64px; padding: 12px 16px 12px 0; display: flex; justify-content: space-between; color: #71767b; font-size: 18px; max-width: 400px; }

/* Action Footer */
.card-action-bar {
    padding: 10px;
    background: #111;
    border-top: 1px solid #333;
    display: flex;
    justify-content: flex-end;
}
.btn-share-real {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
}
.btn-share-real:hover { background: #2563eb; }
.btn-share-real:disabled { opacity: 0.5; cursor: not-allowed; }

.warning-box {
    background: #450a0a; color: #fecaca; padding: 10px; font-size: 12px; margin: 10px; border-radius: 6px; display: none;
}
</style>

  <main class="composer-split-view">
    <!-- LEFT: AI CHAT -->
    <aside class="chat-sidebar">
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="bubble">
                    <strong>Mode √âditeur Live üî¥</strong><br>
                    Pour que ce soit parfait, je vous montre le r√©sultat exact tel qu'il appara√Ætra sur vos r√©seaux √† droite.<br><br>
                    Dites-moi ou collez votre texte, et je mettrai √† jour les pr√©visualisations en temps r√©el.
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <textarea id="userPrompt" class="chat-textarea" placeholder="Votre instruction ici..." style="width:100%; background:#222; color:white; border:none; padding:10px; border-radius:8px;" rows="2"></textarea>
            <button id="sendMessage" style="width:100%; margin-top:10px; background:#3b82f6; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer">G√©n√©rer les Previews ‚û§</button>
        </div>
    </aside>

    <!-- RIGHT: PREVIEW DECK -->
    <section class="preview-deck">
        
        <!-- FACEBOOK CARD -->
        <article class="mockup-card facebook-style" id="preview-facebook" data-platform="facebook">
            <div class="account-status-overlay">üî¥ Compte Facebook non connect√©</div>
            <div class="mockup-content">
                <div class="header">
                    <div class="avatar"></div>
                    <div class="meta">
                        <span class="name">Votre Page</span>
                        <div class="time">Just now ¬∑ <i class="fas fa-globe-americas"></i></div>
                    </div>
                    <i class="fas fa-ellipsis-h" style="color:#b0b3b8"></i>
                </div>
                <div class="body post-text" contenteditable="true">En attente de contenu...</div>
                <div class="media-area"></div>
                <div class="footer">
                    <span><i class="far fa-thumbs-up"></i> J'aime</span>
                    <span><i class="far fa-comment-alt"></i> Commenter</span>
                    <span><i class="fas fa-share"></i> Partager</span>
                </div>
            </div>
            <div class="card-action-bar">
                <button class="btn-share-real" onclick="window.SpreadIt.triggerShare(this, 'facebook')">Publier sur Facebook</button>
            </div>
        </article>

        <!-- INSTAGRAM CARD -->
        <article class="mockup-card instagram-style" id="preview-instagram" data-platform="instagram">
            <div class="account-status-overlay">üî¥ Compte Instagram non connect√©</div>
            <div class="warning-box" id="ig-warning">‚ö†Ô∏è Attention: Format image recommand√© (4:5) ou Vid√©o (9:16).</div>
            <div class="mockup-content">
                <div class="header">
                    <div class="avatar"></div>
                    <span class="name">votre_compte</span>
                    <i class="fas fa-ellipsis-h ms-auto" style="color:white"></i>
                </div>
                <!-- Media takes center stage -->
                <div class="media-area">
                    <span style="color:#666; font-size:12px">M√©dia Appara√Æt Ici</span>
                </div>
                <div class="actions">
                    <i class="far fa-heart"></i>
                    <i class="far fa-comment"></i>
                    <i class="far fa-paper-plane"></i>
                    <i class="far fa-bookmark ms-auto"></i>
                </div>
                <div class="caption-area">
                    <span style="font-weight:600">votre_compte</span>
                    <span class="caption-body post-text" contenteditable="true">En attente de contenu...</span>
                </div>
            </div>
            <div class="card-action-bar">
                <button class="btn-share-real" onclick="window.SpreadIt.triggerShare(this, 'instagram')">Publier sur Instagram</button>
            </div>
        </article>

        <!-- LINKEDIN CARD -->
        <article class="mockup-card linkedin-style" id="preview-linkedin" data-platform="linkedin">
            <div class="account-status-overlay">üî¥ Compte LinkedIn non connect√©</div>
            <div class="mockup-content">
                <div class="header">
                    <div class="avatar"></div>
                    <div>
                        <div class="name">Votre Profil</div>
                        <div style="font-size:12px; color:#aaa">Expert ¬∑ 1st</div>
                        <div style="font-size:12px; color:#aaa">Now ¬∑ <i class="fas fa-globe"></i></div>
                    </div>
                </div>
                <div class="body post-text" contenteditable="true">En attente de contenu...</div>
                <div class="media-area facebook-style"></div> <!-- Reusing FB media style generic -->
                <div class="footer">
                    <span><i class="far fa-thumbs-up"></i> J'aime</span>
                    <span><i class="far fa-comment-dots"></i> Commenter</span>
                    <span><i class="fas fa-share-square"></i> Diffuser</span>
                    <span><i class="fas fa-paper-plane"></i> Envoyer</span>
                </div>
            </div>
            <div class="card-action-bar">
                <button class="btn-share-real" onclick="window.SpreadIt.triggerShare(this, 'linkedin')">Publier sur LinkedIn</button>
            </div>
        </article>

        <!-- TWITTER CARD -->
        <article class="mockup-card twitter-style" id="preview-twitter" data-platform="twitter">
            <div class="account-status-overlay">üî¥ Compte Twitter/X non connect√©</div>
            <div class="mockup-content">
                <div class="header">
                    <div class="avatar"></div>
                    <div class="name-row">
                        <span style="font-weight:700; color:white">You</span>
                        <span class="handle">@yourhandle ¬∑ 1m</span>
                    </div>
                </div>
                <div class="body post-text" contenteditable="true">En attente de contenu...</div>
                <div class="media-container media-area"></div>
                <div class="footer">
                    <i class="far fa-comment"></i>
                    <i class="fas fa-retweet"></i>
                    <i class="far fa-heart"></i>
                    <i class="far fa-chart-bar"></i>
                    <i class="fas fa-share"></i>
                </div>
            </div>
            <div class="card-action-bar">
                <button class="btn-share-real" onclick="window.SpreadIt.triggerShare(this, 'twitter')">Tweeter</button>
            </div>
        </article>

    </section>
  </main>

  <!-- Platform cards template for Chat Injection -->
  <template id="platformCardsTemplate">
    <div class="platform-grid">
    <% const platforms = ['facebook','instagram','twitter','linkedin','tiktok']; %>
    <% platforms.forEach(function(p){ %>
      <article class="platform-wrapper mini-card" data-platform="<%= p %>">
        <div class="platform-header">
            <span class="p-icon <%= p %>"></span> 
            <span class="p-name"><%= p.charAt(0).toUpperCase()+p.slice(1) %></span>
        </div>
        
        <!-- VISUAL PREVIEW CONTAINER -->
        <div class="social-preview theme-dark p-<%= p %>" style="<%= (!configured[p]) ? 'opacity:0.75; filter:grayscale(1);' : '' %>">
            
            <% if ((p === 'instagram') || (p === 'tiktok')) { %>
                <!-- FORMAT VERTICAL / FULL -->
                <div class="sp-full-media">
                   <!-- Image de fond inject√©e ici par JS -->
                   <div class="sp-overlay-text">
                       <div class="sp-text-preview" contenteditable="true">...</div>
                   </div>
                </div>
            <% } else { %>
                <!-- FORMAT FEED (Texte + Media) -->
                <div class="sp-feed-layout">
                    <div class="sp-text-preview" contenteditable="true" style="padding: 10px; font-size: 13px;">...</div>
                    <div class="sp-media-block" style="height: 140px; background-color: #222; background-size: cover; background-position: center;"></div>
                </div>
            <% } %>

        </div>
        <div class="mini-actions">
           <!-- Copier le texte -->
           <button class="btn-xs ghost action-copy" onclick="copyToClipboard(this)">Copier</button>
           
           <!-- Boutons de partage direct -->
           <button class="btn-xs action-share" onclick="window.SpreadIt.triggerShare(this, '<%= p %>')">
               Partager üöÄ
           </button>
        </div>
      </article>
    <% }); %>
    </div>
  </template>

  <!-- REPLACED OLD SCRIPT WITH CHAT LOGIC -->
  <script>
    // Pass server-side config to client
    const USER_CONFIG = JSON.parse('<%- JSON.stringify(configured || {}) %>');
    
    // Auto-resize textarea
    const tx = document.getElementById('userPrompt');
    if(tx) {
        tx.addEventListener("input", function(){
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        });
        tx.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
    }

    // Expose Share Trigger Globally
    window.SpreadIt = window.SpreadIt || {};
    window.SpreadIt.triggerShare = function(btn, platform) {
        const card = btn.closest('.mini-card');
        const textElement = card.querySelector('.sp-text-preview');
        const content = textElement ? textElement.innerText : '';
        
        if (!content || content === '...') {
            alert('Veuillez d\'abord g√©n√©rer du contenu avec l\'IA.');
            return;
        }

        // Disable button to prevent double-click
        const originalText = btn.innerText;
        btn.innerText = 'Envoi...';
        btn.disabled = true;

        // Payload for smart-share endpoint
        const payload = {
            mediaUrl: window.CURRENT_VIDEO_URL || window.CURRENT_POSTER || null,
            mediaType: window.CURRENT_VIDEO_URL ? 'video' : 'image',
            caption: content,
            platforms: [platform],
            hashtags: [] 
        };

        fetch('/api/smart-share-submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                btn.innerText = '‚úÖ Publi√© !';
                btn.classList.add('success');
            } else {
                btn.innerText = 'Erreur';
                // Show error details if available
                let msg = data.message || 'Erreur inconnue';
                if(data.errors && data.errors.length) msg += '\n' + data.errors[0].error;
                alert('Echec du partage : ' + msg);
            }
        })
        .catch(err => {
            console.error(err);
            btn.innerText = 'Erreur R√©seau';
            alert('Impossible de contacter le serveur.');
        })
        .finally(() => {
            // Re-enable button after delay if needed (or leave as Published)
            setTimeout(() => {
                if(btn.innerText !== '‚úÖ Publi√© !') {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }, 3000);
        });
    };

    // Simple script to handle Chat logic -> UI
    const sendBtn = document.getElementById('sendMessage');
    if(sendBtn) sendBtn.addEventListener('click', () => handleSend());

    // --- AUTO-DETECT PREFILLED CONTENT (Video / Media / Meta) ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const prefill = params.get('prefill');
        const videoUrl = params.get('video_url'); // Priority 1
        const posterUrl = params.get('poster');   // Priority 2
        const title = params.get('title');
        const description = params.get('description');
        const keywords = params.get('keywords');
        const author = params.get('author');
        
        // --- 1. MEDIA PRIORITY LOGIC ---
        // Always try to use video first, if explicitly provided.
        if(videoUrl && videoUrl !== 'undefined' && videoUrl !== 'null') {
             window.CURRENT_VIDEO_URL = videoUrl;
             // If we have a video, the poster is secondary (thumbnail), but useful for social cards that need static img
             if(posterUrl) window.CURRENT_POSTER = posterUrl;
        } else if (posterUrl && posterUrl !== 'undefined') {
             // Fallback: No video, but we have a poster/thumbnail
             window.CURRENT_POSTER = posterUrl;
             window.CURRENT_VIDEO_URL = null; // Explicitly nullify
        }

        if(title) window.CURRENT_TITLE = title;
        
        // Store Meta for AI Context
        window.CURRENT_METADATA = {
            keywords: keywords || "",
            author: author || "",
            description: description || ""
        };

        if(window.CURRENT_VIDEO_URL || window.CURRENT_POSTER || title) {
            // Show a "System" message indicating detection
            let visualHtml = `üé• M√©dia d√©tect√© : <strong>${title || 'Source Externe'}</strong>`;
            
            // Show thumbnail/poster in chat
            const thumbToShow = window.CURRENT_POSTER || (window.CURRENT_VIDEO_URL && !window.CURRENT_VIDEO_URL.endsWith('.mp4') ? window.CURRENT_VIDEO_URL : null);
            
            if(thumbToShow) {
                visualHtml += `<br><img src="${thumbToShow}" style="max-width:120px; border-radius:8px; margin-top:8px; display:block; border:1px solid #333;" alt="Aper√ßu">`;
            }
            
            if(window.CURRENT_VIDEO_URL) visualHtml += `<div style="font-size:0.8em; color:#4ade80; margin-top:4px">‚úì Vid√©o charg√©e</div>`;
            else if(window.CURRENT_POSTER) visualHtml += `<div style="font-size:0.8em; color:#fbbf24; margin-top:4px">‚úì Image/Thumbnail charg√©e (mode image)</div>`;

            visualHtml += `<br><span style="font-size:0.9em; opacity:0.8">Analyse des m√©tadonn√©es & g√©n√©ration...</span>`;
            
            addMessage('ai', visualHtml);
            
            // Auto-trigger generation with richer context
            let prompt = `Je veux partager ce contenu : "${title || 'Nouveau contenu'}".\n`;
            if(window.CURRENT_VIDEO_URL) prompt += `Type: Vid√©o\nLien: ${window.CURRENT_VIDEO_URL}\n`;
            else prompt += `Type: Image/Article\n`;

            if(window.CURRENT_METADATA.description) prompt += `\nDescription/Contexte: "${window.CURRENT_METADATA.description}"\n`;
            if(window.CURRENT_METADATA.keywords) prompt += `Mots-cl√©s / Tags (√† utiliser): ${window.CURRENT_METADATA.keywords}\n`;
            if(window.CURRENT_METADATA.author) prompt += `Auteur: ${window.CURRENT_METADATA.author}\n`;
            
            prompt += `\nINSTRUCTION: G√©n√®re des posts engageants pour mes r√©seaux. Inclus les mots-cl√©s fournis dans les hashtags si pertinent. Adapte le ton au contenu.`;
            
            handleSend(prompt);
        }
        
        if (params.get('platforms')) {
           // Handle platform selection updates if needed
        }
    });


    // --- UPDATED LOGIC FOR REALISTIC DECK ---

    // 1. Initialize Deck State based on Config
    document.addEventListener('DOMContentLoaded', () => {
        const platforms = ['facebook', 'instagram', 'linkedin', 'twitter'];
        platforms.forEach(p => {
            const card = document.getElementById(`preview-${p}`);
            if(!card) return;
            
            const isConnected = USER_CONFIG[p];
            if (!isConnected) {
                card.classList.add('disconnected');
            } else {
                card.classList.remove('disconnected');
            }
        });
    });

    async function handleSend(forcedText = null){
        const input = document.getElementById('userPrompt');
        let txt = forcedText || input.value.trim();
        
        if(!txt) return;

        // Add user message to small chat log
        const chatLog = document.getElementById('chatMessages');
        if (!forcedText) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user';
            msgDiv.innerHTML = `<div class="bubble">${txt}</div>`;
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            input.value = '';
        }

        // Add AI loading
        const loaderDiv = document.createElement('div');
        loaderDiv.className = 'message ai';
        loaderDiv.id = 'ai-loader';
        loaderDiv.innerHTML = `<div class="bubble">G√©n√©ration des variantes en cours... <i class="fas fa-spinner fa-spin"></i></div>`;
        chatLog.appendChild(loaderDiv);
        chatLog.scrollTop = chatLog.scrollHeight;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: txt,
                    platforms: Object.keys(USER_CONFIG),
                    media: {
                        type: window.CURRENT_VIDEO_URL ? 'video' : (window.CURRENT_POSTER ? 'image' : null),
                        url: window.CURRENT_VIDEO_URL || window.CURRENT_POSTER,
                        poster: window.CURRENT_POSTER,
                        title: window.CURRENT_TITLE
                    }
                })
            });

            if(!response.ok) throw new Error("Erreur r√©seau");

            const data = await response.json(); 
            
            // Remove Loader
            loaderDiv.remove();

            // Add AI Reply Log
            const replyDiv = document.createElement('div');
            replyDiv.className = 'message ai';
            replyDiv.innerHTML = `<div class="bubble">${data.reply || "Previews mises √† jour  !"}</div>`;
            chatLog.appendChild(replyDiv);

            // UPDATE RIGHT DECK
            if (data.cards) {
                Object.keys(data.cards).forEach(platform => {
                    const card = document.getElementById(`preview-${platform}`);
                    if (!card) return;

                    // Update Text
                    const textEl = card.querySelector('.post-text');
                    if(textEl) textEl.innerText = data.cards[platform];

                    // Update Media (if present)
                    const mediaArea = card.querySelector('.media-area');
                    if (mediaArea) {
                        mediaArea.innerHTML = ''; // Clear
                        const mediaType = data.mediaUsed?.type || (window.CURRENT_VIDEO_URL ? 'video' : 'image');
                        const mediaUrl = data.mediaUsed?.url || window.CURRENT_VIDEO_URL || window.CURRENT_POSTER;

                        if (mediaUrl) {
                            if (mediaType === 'video') {
                                mediaArea.innerHTML = `<video src="${mediaUrl}" controls style="max-width:100%; max-height:100%"></video>`;
                            } else {
                                mediaArea.innerHTML = `<img src="${mediaUrl}" style="width:100%; height:auto;">`;
                            }
                        } else if (platform === 'instagram' && !mediaUrl) {
                             mediaArea.innerHTML = `<div style="padding:20px; text-align:center; color:red">‚ö†Ô∏è M√©dia requis pour Instragram</div>`;
                        }
                    }
                });
            }
            
        } catch (e) {
            loaderDiv.innerHTML = `<div class="bubble" style="background:#450a0a; color:#fecaca">Erreur: ${e.message}</div>`;
        }
    }

    function addMessage(type, html) {
        const id = 'msg-' + Date.now();
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.id = id;
        div.innerHTML = `
            ${type === 'ai' ? '<div class="avatar">ü§ñ</div>' : ''}
            <div class="bubble">${html}</div>
        `;
        document.getElementById('chatMessages').appendChild(div);
        return id;
    }
    
    function copyToClipboard(btn) {
        // ... (Logic handled inline for simplicity or separated)
        // Note: The click handler in the template calls this, but we overrode it in JS for logic
    }
  </script>

