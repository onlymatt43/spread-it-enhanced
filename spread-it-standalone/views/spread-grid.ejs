<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spread It - Mes Publications</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-light: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      --card-bg: #ffffff;
      --border: rgba(0,0,0,0.08);
      --text: #1a1a1a;
      --text-muted: #6b7280;
      
      /* Platform colors */
      --facebook: #1877F2;
      --instagram-start: #F58529;
      --instagram-end: #DD2A7B;
      --twitter: #000000;
      --linkedin: #0A66C2;
      --tiktok-start: #25F4EE;
      --tiktok-end: #FE2C55;
      --youtube: #FF0000;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      color: var(--text);
      padding: 80px 20px 40px;
      min-height: 100vh;
    }

    /* HEADER */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .logo {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* MASONRY LAYOUT */
    .spreads-grid {
      column-count: 3;
      column-gap: 48px;
      max-width: 1400px;
      margin: 0 auto;
    }

    @media (max-width: 1024px) {
      .spreads-grid { column-count: 2; column-gap: 36px; }
    }

    @media (max-width: 640px) {
      .spreads-grid { column-count: 1; column-gap: 0; }
    }

    /* PLATFORM CARD */
    .platform-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.06),
        0 2px 6px rgba(0, 0, 0, 0.04),
        0 10px 30px rgba(0, 0, 0, 0.08);
      break-inside: avoid;
      margin-bottom: 48px;
      display: inline-block;
      width: 100%;
    }

    /* Rotation variations for organic feel */
    .platform-card:nth-child(6n+1) { transform: rotate(-1.5deg); }
    .platform-card:nth-child(6n+2) { transform: rotate(1deg); }
    .platform-card:nth-child(6n+3) { transform: rotate(-0.8deg); }
    .platform-card:nth-child(6n+4) { transform: rotate(1.8deg); }
    .platform-card:nth-child(6n+5) { transform: rotate(-2deg); }
    .platform-card:nth-child(6n+6) { transform: rotate(0.5deg); }

    .platform-card:hover {
      transform: translateY(-12px) scale(1.02) !important;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.12),
        0 10px 20px rgba(0, 0, 0, 0.08),
        0 4px 8px rgba(0, 0, 0, 0.06);
    }

    /* Accentuate rotation on hover */
    .platform-card:nth-child(6n+1):hover { transform: translateY(-12px) scale(1.02) rotate(-2.5deg) !important; }
    .platform-card:nth-child(6n+2):hover { transform: translateY(-12px) scale(1.02) rotate(2deg) !important; }
    .platform-card:nth-child(6n+3):hover { transform: translateY(-12px) scale(1.02) rotate(-1.5deg) !important; }
    .platform-card:nth-child(6n+4):hover { transform: translateY(-12px) scale(1.02) rotate(3deg) !important; }
    .platform-card:nth-child(6n+5):hover { transform: translateY(-12px) scale(1.02) rotate(-3deg) !important; }
    .platform-card:nth-child(6n+6):hover { transform: translateY(-12px) scale(1.02) rotate(1.5deg) !important; }

    /* PLATFORM HEADER (colored) */
    .platform-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 15px;
    }

    .platform-header.facebook {
      background: var(--facebook);
      color: white;
    }

    .platform-header.instagram {
      background: linear-gradient(135deg, var(--instagram-start), var(--instagram-end));
      color: white;
    }

    .platform-header.twitter {
      background: var(--twitter);
      color: white;
    }

    .platform-header.linkedin {
      background: var(--linkedin);
      color: white;
    }

    .platform-header.tiktok {
      background: linear-gradient(135deg, var(--tiktok-start), var(--tiktok-end));
      color: white;
    }

    .platform-header.youtube {
      background: var(--youtube);
      color: white;
    }

    /* MEDIA PREVIEW */
    .media-preview {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
    }

    .media-preview video,
    .media-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .status-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    /* POST CONTENT */
    .post-content {
      padding: 20px;
    }

    .post-text {
      background: rgba(0,0,0,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      min-height: 80px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* ACTIONS */
    .card-actions {
      padding: 16px 20px;
      display: flex;
      gap: 10px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.01);
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-chat {
      background: rgba(99, 102, 241, 0.15);
      color: #6366f1;
      border: 1px solid #6366f1;
    }

    .btn-chat:hover {
      background: rgba(99, 102, 241, 0.25);
    }

    .btn-publish {
      background: #10b981;
      color: white;
    }

    .btn-publish:hover {
      background: #059669;
    }

    .btn-delete {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid #ef4444;
      flex: 0;
      padding: 10px 14px;
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    .btn-connect {
      background: rgba(249, 115, 22, 0.15);
      color: #f97316;
      border: 1px solid #f97316;
    }

    .btn-connect:hover {
      background: rgba(249, 115, 22, 0.25);
    }

    .btn-publish:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* CONNECTION STATUS BADGE */
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: auto;
    }

    .connection-status.connected {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .connection-status.disconnected {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .connection-status.checking {
      background: rgba(156, 163, 175, 0.15);
      color: #9ca3af;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
      grid-column: 1 / -1;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h2 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text);
    }

    /* CHAT MODAL (hidden by default) */
    .chat-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .chat-modal.active {
      display: flex;
    }

    .chat-container {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.2),
        0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header h3 {
      font-size: 18px;
    }

    .close-chat {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .close-chat:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-message {
      display: flex;
      gap: 12px;
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .message-bubble {
      background: rgba(255,255,255,0.05);
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 80%;
      font-size: 14px;
      line-height: 1.5;
    }

    .chat-message.user .message-bubble {
      background: #6366f1;
      color: white;
    }

    .chat-input-container {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 16px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .chat-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    .send-btn {
      background: #6366f1;
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .send-btn:hover {
      background: #4f46e5;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <header class="top-header">
    <div class="logo">
      üöÄ Spread It
    </div>
    <div style="color: var(--text-muted); font-size: 14px;">
      <%= spreads ? spreads.length : 0 %> spread(s)
    </div>
  </header>

  <main class="spreads-grid">
    
    <% if (spreads && spreads.length > 0) { %>
      <% spreads.forEach(spread => { %>
        <% spread.platforms.forEach(platform => { %>
          <% const platformContent = spread.content[platform]; %>
          <% if (platformContent) { %>
    
    <!-- PLATFORM CARD -->
    <article class="platform-card" data-spread-id="<%= spread.id %>" data-platform="<%= platform %>">
      
      <!-- PLATFORM HEADER (colored) -->
      <div class="platform-header <%= platform %>">
        <% if (platform === 'facebook') { %>
          <i class="fab fa-facebook-f"></i> Facebook
        <% } else if (platform === 'instagram') { %>
          <i class="fab fa-instagram"></i> Instagram
        <% } else if (platform === 'twitter') { %>
          <i class="fab fa-x-twitter"></i> Twitter
        <% } else if (platform === 'linkedin') { %>
          <i class="fab fa-linkedin-in"></i> LinkedIn
        <% } else if (platform === 'tiktok') { %>
          <i class="fab fa-tiktok"></i> TikTok
        <% } else if (platform === 'youtube') { %>
          <i class="fab fa-youtube"></i> YouTube
        <% } %>
        
        <!-- CONNECTION STATUS -->
        <span class="connection-status checking" data-platform="<%= platform %>">
          <span class="status-dot"></span>
          <span class="status-text">...</span>
        </span>
      </div>

      <!-- MEDIA PREVIEW -->
      <div class="media-preview">
        <% if (spread.media_type === 'image') { %>
          <img src="<%= spread.media_url %>" alt="Media">
        <% } else { %>
          <video src="<%= spread.media_url %>" muted loop></video>
        <% } %>
        <span class="status-badge"><%= spread.status === 'published' ? 'Published' : 'Draft' %></span>
      </div>

      <!-- POST CONTENT -->
      <div class="post-content">
        <div class="post-text" data-editable="true">
          <%= platformContent %>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="card-actions">
        <button class="btn btn-chat" onclick="openChat('<%= spread.id %>', '<%= platform %>')">
          <i class="fas fa-comments"></i> Chat AI
        </button>
        <button class="btn btn-publish" data-spread-id="<%= spread.id %>" data-platform="<%= platform %>" onclick="publishPost('<%= spread.id %>', '<%= platform %>')" disabled>
          <i class="fas fa-rocket"></i> <span class="publish-text">V√©rification...</span>
        </button>
        <button class="btn btn-delete" onclick="deletePost('<%= spread.id %>', '<%= platform %>')">
          <i class="fas fa-trash"></i>
        </button>
      </div>

    </article>

          <% } %>
        <% }) %>
      <% }) %>
    <% } else { %>
    
    <!-- EMPTY STATE -->
    <div class="empty-state">
      <i class="fas fa-images"></i>
      <h2>Aucun Spread It pour l'instant</h2>
      <p>Cliquez sur le logo Spread It üöÄ sur vos m√©dias pour cr√©er votre premier post multi-plateformes!</p>
    </div>
    
    <% } %>

  </main>

  <!-- CHAT MODAL (hidden) -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">
        <h3 id="chatTitle">Chat AI - Facebook</h3>
        <button class="close-chat" onclick="closeChat()">√ó</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message ai">
          <div class="message-bubble">
            Salut! Je suis l'AI sp√©cialis√© pour cette plateforme. Dis-moi comment tu veux modifier ce post!
          </div>
        </div>
      </div>
      <div class="chat-input-container">
        <input 
          type="text" 
          class="chat-input" 
          id="chatInput" 
          placeholder="Ex: Rends √ßa plus court..."
          onkeypress="handleChatKeypress(event)"
        >
        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentSpreadId = null;
    let currentPlatform = null;
    let platformStatuses = {};

    // Check platform connection status on page load
    async function checkPlatformStatuses() {
      try {
        const response = await fetch('/api/platforms/status');
        const statuses = await response.json();
        platformStatuses = statuses;

        // Update all status badges and buttons
        Object.keys(statuses).forEach(platform => {
          const status = statuses[platform];
          
          // Update status badges
          const badges = document.querySelectorAll(`.connection-status[data-platform="${platform}"]`);
          badges.forEach(badge => {
            const statusDot = badge.querySelector('.status-dot');
            const statusText = badge.querySelector('.status-text');
            
            if (status.connected) {
              badge.classList.remove('checking', 'disconnected');
              badge.classList.add('connected');
              statusText.textContent = 'Connect√©';
            } else {
              badge.classList.remove('checking', 'connected');
              badge.classList.add('disconnected');
              statusText.textContent = 'Non connect√©';
            }
          });

          // Update publish buttons
          const buttons = document.querySelectorAll(`.btn-publish[data-platform="${platform}"]`);
          buttons.forEach(button => {
            const publishText = button.querySelector('.publish-text');
            
            if (status.connected) {
              button.disabled = false;
              button.classList.remove('btn-connect');
              button.classList.add('btn-publish');
              button.style.background = '#10b981';
              button.style.color = 'white';
              button.style.border = 'none';
              publishText.textContent = 'Publier';
              button.querySelector('i').className = 'fas fa-rocket';
            } else {
              button.disabled = false;
              button.classList.remove('btn-publish');
              button.classList.add('btn-connect');
              button.style.background = 'rgba(249, 115, 22, 0.15)';
              button.style.color = '#f97316';
              button.style.border = '1px solid #f97316';
              publishText.textContent = 'Connecter';
              button.querySelector('i').className = 'fas fa-plug';
              
              // Change onclick to connect flow
              const spreadId = button.dataset.spreadId;
              button.onclick = () => connectPlatform(platform);
            }
          });
        });

        console.log('[Platform Status]', statuses);

      } catch (error) {
        console.error('Failed to check platform statuses:', error);
        
        // Mark all as unknown on error
        document.querySelectorAll('.connection-status').forEach(badge => {
          badge.classList.remove('checking', 'connected');
          badge.classList.add('disconnected');
          badge.querySelector('.status-text').textContent = 'Erreur';
        });
      }
    }

    function connectPlatform(platform) {
      const platformNames = {
        facebook: 'Facebook',
        instagram: 'Instagram',
        twitter: 'Twitter',
        linkedin: 'LinkedIn',
        tiktok: 'TikTok',
        youtube: 'YouTube'
      };

      alert(`Pour connecter ${platformNames[platform]}, vous devez:\n\n1. Obtenir un nouveau access token\n2. L'ajouter dans .env.local\n3. Red√©marrer le serveur\n\nVoir SOCIAL-PUBLISHING-SETUP.md pour les instructions d√©taill√©es.`);
      
      // TODO: Implement OAuth flow
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', () => {
      checkPlatformStatuses();
    });

    function openChat(spreadId, platform) {
      currentSpreadId = spreadId;
      currentPlatform = platform;
      
      const platformNames = {
        facebook: 'Facebook',
        instagram: 'Instagram',
        twitter: 'Twitter',
        linkedin: 'LinkedIn',
        tiktok: 'TikTok',
        youtube: 'YouTube'
      };
      
      document.getElementById('chatTitle').textContent = `Chat AI - ${platformNames[platform]}`;
      document.getElementById('chatModal').classList.add('active');
      document.getElementById('chatInput').focus();
      
      // Reset chat messages
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = `
        <div class="chat-message ai">
          <div class="message-bubble">
            Salut! Je suis l'AI sp√©cialis√© ${platformNames[platform]}. Dis-moi comment tu veux modifier ce post!
          </div>
        </div>
      `;
    }

    function closeChat() {
      document.getElementById('chatModal').classList.remove('active');
      currentSpreadId = null;
      currentPlatform = null;
    }

    function handleChatKeypress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !currentSpreadId || !currentPlatform) return;
      
      // Add user message to chat
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML += `
        <div class="chat-message user">
          <div class="message-bubble">${message}</div>
        </div>
      `;
      
      input.value = '';
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Disable send button
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      
      try {
        // Call AI chat API
        const response = await fetch('/api/edit-spread-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            spreadId: currentSpreadId,
            platform: currentPlatform,
            userMessage: message
          })
        });
        
        if (!response.ok) throw new Error('Failed to send message');
        
        const data = await response.json();
        
        // Add AI response
        messagesContainer.innerHTML += `
          <div class="chat-message ai">
            <div class="message-bubble">${data.aiResponse}</div>
          </div>
        `;
        
        // Update post text if modified
        if (data.updatedText) {
          const card = document.querySelector(`[data-spread-id="${currentSpreadId}"][data-platform="${currentPlatform}"]`);
          if (card) {
            card.querySelector('.post-text').textContent = data.updatedText;
          }
        }
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
      } catch (error) {
        console.error('Chat error:', error);
        messagesContainer.innerHTML += `
          <div class="chat-message ai">
            <div class="message-bubble">D√©sol√©, une erreur est survenue. R√©essaye!</div>
          </div>
        `;
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function publishPost(spreadId, platform) {
      const platformNames = {
        facebook: 'Facebook',
        instagram: 'Instagram',
        twitter: 'Twitter',
        linkedin: 'LinkedIn',
        tiktok: 'TikTok',
        youtube: 'YouTube'
      };

      if (!confirm(`Publier ce post sur ${platformNames[platform]}?`)) {
        return;
      }

      // Find the button to show loading state
      const card = document.querySelector(`[data-spread-id="${spreadId}"][data-platform="${platform}"]`);
      const publishBtn = card.querySelector('.btn-publish');
      const originalText = publishBtn.innerHTML;
      
      try {
        publishBtn.disabled = true;
        publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publication...';

        const response = await fetch('/api/publish-spread', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spreadId, platform })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.details || data.error || 'Publication √©chou√©e');
        }

        // Success
        publishBtn.innerHTML = '<i class="fas fa-check"></i> Publi√©!';
        publishBtn.style.background = '#10b981';
        
        // Show URL if available
        if (data.url) {
          setTimeout(() => {
            if (confirm(`Publi√© avec succ√®s! Voir sur ${platformNames[platform]}?`)) {
              window.open(data.url, '_blank');
            }
          }, 500);
        } else {
          alert(`Publi√© sur ${platformNames[platform]} avec succ√®s!`);
        }

        // Reset button after 3 seconds
        setTimeout(() => {
          publishBtn.innerHTML = originalText;
          publishBtn.disabled = false;
        }, 3000);

      } catch (error) {
        console.error('Publish error:', error);
        alert(`Erreur de publication: ${error.message}`);
        publishBtn.innerHTML = originalText;
        publishBtn.disabled = false;
      }
    }

    function deletePost(spreadId, platform) {
      if (confirm(`Supprimer ce post ${platform}?`)) {
        // TODO: Implement delete
        console.log('Delete:', spreadId, platform);
        location.reload();
      }
    }

    // Close modal on outside click
    document.getElementById('chatModal').addEventListener('click', (e) => {
      if (e.target.id === 'chatModal') {
        closeChat();
      }
    });
  </script>

</body>
</html>
