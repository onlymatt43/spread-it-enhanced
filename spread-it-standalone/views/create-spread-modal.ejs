<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Spread - Spread It</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-dark: #0a0a0b;
      --card-bg: #1a1a1c;
      --border: #333;
      --text: #e4e4e7;
      --text-muted: #a1a1aa;
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* MODAL CONTAINER */
    .modal-container {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    /* HEADER */
    .modal-header {
      background: linear-gradient(135deg, var(--primary), #ec4899);
      padding: 24px;
      text-align: center;
      position: relative;
    }

    .modal-header h1 {
      font-size: 24px;
      font-weight: 800;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .modal-header .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-header .close-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }

    /* CONTENT */
    .modal-content {
      padding: 24px;
    }

    /* MEDIA PREVIEW */
    .media-preview {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .media-preview video,
    .media-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .media-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(99, 102, 241, 0.9);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: white;
    }

    /* AI SUGGESTION SECTION */
    .ai-section {
      margin-bottom: 24px;
    }

    .section-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .ai-suggestion {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 12px;
      padding: 16px;
      font-size: 15px;
      line-height: 1.6;
      color: var(--text);
      position: relative;
    }

    .ai-suggestion .loading {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
    }

    .ai-suggestion .loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* USER INPUT SECTION */
    .user-section {
      margin-bottom: 24px;
    }

    .user-input-container {
      position: relative;
    }

    .user-input {
      width: 100%;
      min-height: 100px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      padding-right: 60px; /* Space for mic button */
      font-size: 15px;
      color: var(--text);
      font-family: inherit;
      resize: vertical;
      transition: all 0.2s;
    }

    .user-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255,255,255,0.08);
    }

    .user-input::placeholder {
      color: var(--text-muted);
    }

    .input-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      font-style: italic;
    }

    /* VOICE RECORDING BUTTON */
    .mic-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      font-size: 16px;
    }

    .mic-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(1.05);
    }

    .mic-btn.recording {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .mic-btn.recording i {
      animation: scale-pulse 0.8s ease-in-out infinite;
    }

    @keyframes scale-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .voice-status {
      font-size: 11px;
      color: var(--danger);
      margin-top: 4px;
      font-weight: 600;
      display: none;
    }

    .voice-status.active {
      display: block;
    }

    /* PLATFORM SELECTION */
    .platform-section {
      margin-bottom: 24px;
    }

    .platform-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .platform-btn {
      background: rgba(255,255,255,0.05);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .platform-btn i {
      font-size: 24px;
    }

    .platform-btn .name {
      font-size: 13px;
      font-weight: 600;
    }

    .platform-btn:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .platform-btn.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.2);
    }

    .platform-btn.active i {
      color: var(--primary);
    }

    /* Platform Colors */
    .platform-btn[data-platform="facebook"].active i { color: #1877f2; }
    .platform-btn[data-platform="instagram"].active i { color: #e4405f; }
    .platform-btn[data-platform="twitter"].active i { color: #1da1f2; }
    .platform-btn[data-platform="linkedin"].active i { color: #0a66c2; }
    .platform-btn[data-platform="tiktok"].active i { color: #fe2c55; }
    .platform-btn[data-platform="youtube"].active i { color: #ff0000; }

    /* FOOTER */
    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary .loading {
      display: none;
    }

    .btn-primary.loading .loading {
      display: inline-block;
    }

    .btn-primary.loading .text {
      display: none;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .platform-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .modal-footer {
        flex-direction: column;
      }

      .modal-header h1 {
        font-size: 20px;
      }
    }

  </style>
</head>
<body>

  <div class="modal-container" id="modalContainer">
    
    <!-- HEADER -->
    <div class="modal-header">
      <button class="close-btn" onclick="window.close()">
        <i class="fas fa-times"></i>
      </button>
      <h1>
        <i class="fas fa-rocket"></i>
        Create Spread It Post
      </h1>
    </div>

    <!-- CONTENT -->
    <div class="modal-content" id="modalBody">
      
      <!-- MEDIA PREVIEW -->
      <div class="media-preview">
        <span class="media-badge">From Media</span>
        <video id="mediaPreview" src="" controls playsinline></video>
      </div>

      <!-- AI SUGGESTION -->
      <div class="ai-section">
        <div class="section-label">
          <i class="fas fa-magic"></i>
          AI Suggestion (from metadata)
        </div>
        <div class="ai-suggestion" id="aiSuggestion">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            Analyzing media metadata...
          </div>
        </div>
      </div>

      <!-- USER INPUT -->
      <div class="user-section">
        <div class="section-label">
          <i class="fas fa-pen"></i>
          Your Addition (optional)
        </div>
        <div class="user-input-container">
          <textarea 
            id="userInput" 
            class="user-input" 
            placeholder="Add your own text here... (will be spell-checked, not transformed by AI)"
          ></textarea>
          <button type="button" class="mic-btn" id="micBtn" title="Click to dictate">
            <i class="fas fa-microphone"></i>
          </button>
        </div>
        <div class="voice-status" id="voiceStatus">üéôÔ∏è Listening...</div>
        <div class="input-hint">
          üí° Your text will be corrected but not changed by AI ‚Ä¢ Click üé§ to dictate
        </div>
      </div>

      <!-- PLATFORM SELECTION -->
      <div class="platform-section">
        <div class="section-label">
          <i class="fas fa-share-alt"></i>
          Post to:
        </div>
        <div class="platform-grid">
          <button class="platform-btn active" data-platform="facebook">
            <i class="fab fa-facebook-f"></i>
            <span class="name">Facebook</span>
          </button>
          <button class="platform-btn active" data-platform="instagram">
            <i class="fab fa-instagram"></i>
            <span class="name">Instagram</span>
          </button>
          <button class="platform-btn" data-platform="twitter">
            <i class="fab fa-x-twitter"></i>
            <span class="name">Twitter</span>
          </button>
          <button class="platform-btn" data-platform="linkedin">
            <i class="fab fa-linkedin-in"></i>
            <span class="name">LinkedIn</span>
          </button>
          <button class="platform-btn" data-platform="tiktok">
            <i class="fab fa-tiktok"></i>
            <span class="name">TikTok</span>
          </button>
          <button class="platform-btn" data-platform="youtube">
            <i class="fab fa-youtube"></i>
            <span class="name">YouTube</span>
          </button>
        </div>
      </div>

    </div>

    <!-- FOOTER -->
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="window.close()">
        <i class="fas fa-times"></i>
        Cancel
      </button>
      <button class="btn btn-primary" id="generateBtn">
        <span class="text">
          <i class="fas fa-magic"></i>
          Generate Posts
        </span>
        <span class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          Generating...
        </span>
      </button>
    </div>

  </div>

  <script>
    // Get media URL from query params
    const urlParams = new URLSearchParams(window.location.search);
    const mediaUrl = urlParams.get('media');
    const mediaType = urlParams.get('type') || 'video';
    const mediaTitle = urlParams.get('title') || '';

    // Set media preview
    const mediaPreview = document.getElementById('mediaPreview');
    if (mediaType === 'image') {
      mediaPreview.outerHTML = `<img id="mediaPreview" src="${mediaUrl}" alt="Media">`;
    } else {
      mediaPreview.src = mediaUrl;
    }

    // Platform selection toggle
    document.querySelectorAll('.platform-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('active');
      });
    });

    // Extract metadata on load
    async function extractMetadata() {
      try {
        const response = await fetch('/api/extract-metadata', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            mediaUrl,
            mediaType,
            title: mediaTitle
          })
        });

        if (!response.ok) throw new Error('Failed to extract metadata');

        const data = await response.json();
        
        // Update AI suggestion
        document.getElementById('aiSuggestion').innerHTML = data.suggestion || 'No metadata found';

      } catch (error) {
        console.error('Metadata extraction failed:', error);
        document.getElementById('aiSuggestion').innerHTML = `
          <div style="color: var(--text-muted);">
            Unable to analyze metadata. You can still add your own text below.
          </div>
        `;
      }
    }

    // Generate posts
    document.getElementById('generateBtn').addEventListener('click', async () => {
      const btn = document.getElementById('generateBtn');
      const selectedPlatforms = Array.from(document.querySelectorAll('.platform-btn.active'))
        .map(btn => btn.dataset.platform);

      if (selectedPlatforms.length === 0) {
        alert('Please select at least one platform');
        return;
      }

      btn.classList.add('loading');
      btn.disabled = true;

      try {
        const response = await fetch('/api/create-spread', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mediaUrl,
            mediaType,
            aiSuggestion: document.getElementById('aiSuggestion').innerText,
            userText: document.getElementById('userInput').value,
            platforms: selectedPlatforms
          })
        });

        if (!response.ok) throw new Error('Failed to create spread');

        const data = await response.json();

        // Redirect directly to spreads grid
        window.location.href = '/spreads';

      } catch (error) {
        console.error('Spread creation failed:', error);
        alert('Failed to create spread: ' + error.message);
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    });

    // VOICE DICTATION FEATURE
    const micBtn = document.getElementById('micBtn');
    const userInput = document.getElementById('userInput');
    const voiceStatus = document.getElementById('voiceStatus');
    let recognition = null;
    let isRecording = false;

    // Check if browser supports speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.continuous = true; // Keep listening
      recognition.interimResults = true; // Show partial results
      recognition.lang = 'fr-CA'; // Qu√©bec French (can auto-detect en-US too)
      
      recognition.onstart = () => {
        isRecording = true;
        micBtn.classList.add('recording');
        voiceStatus.classList.add('active');
        console.log('üé§ Voice recognition started');
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }

        // Append final transcript to textarea
        if (finalTranscript) {
          const currentText = userInput.value;
          userInput.value = currentText + finalTranscript;
        }

        // Update status with interim results
        if (interimTranscript) {
          voiceStatus.textContent = `üéôÔ∏è ${interimTranscript}`;
        }
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          voiceStatus.textContent = 'üéôÔ∏è No speech detected, try again';
        } else if (event.error === 'not-allowed') {
          alert('Microphone access denied. Please enable it in your browser settings.');
        } else {
          voiceStatus.textContent = `‚ùå Error: ${event.error}`;
        }
        stopRecording();
      };

      recognition.onend = () => {
        stopRecording();
      };

      micBtn.addEventListener('click', () => {
        if (isRecording) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });

      function stopRecording() {
        isRecording = false;
        micBtn.classList.remove('recording');
        setTimeout(() => {
          voiceStatus.classList.remove('active');
          voiceStatus.textContent = 'üéôÔ∏è Listening...';
        }, 1500);
      }

    } else {
      // Browser doesn't support speech recognition
      micBtn.style.display = 'none';
      console.warn('Speech recognition not supported in this browser');
    }

    // Auto-extract metadata on load
    extractMetadata();
  </script>

</body>
</html>
