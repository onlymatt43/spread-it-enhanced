<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Social Media Auth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            margin-bottom: 40px;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .platform-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .platform-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        }

        .platform-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .platform-icon {
            font-size: 40px;
        }

        .platform-name {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .status-badge.connected {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .status-badge.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .platform-info {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 16px;
            min-height: 40px;
        }

        .platform-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .platform-btn.connect {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .platform-btn.connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .platform-btn.connected {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 2px solid #10b981;
        }

        .platform-btn.disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .instructions {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .instructions h2 {
            color: #1a202c;
            font-size: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instruction-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #6366f1;
        }

        .instruction-item strong {
            color: #1a202c;
            display: block;
            margin-bottom: 8px;
        }

        .instruction-item code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #be185d;
        }

        .warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .warning strong {
            color: #92400e;
            display: block;
            margin-bottom: 8px;
        }

        .warning p {
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë Social Media Setup</h1>
        <p class="subtitle">Connectez vos plateformes en un clic</p>

        <div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:16px 20px;margin-bottom:24px;color:#78350f;font-size:14px;line-height:1.6;">
            <strong>‚ö†Ô∏è Apr√®s chaque connexion</strong> ‚Äî la page affiche un token √† copier. Tu dois le coller manuellement dans
            <a href="https://dashboard.render.com" target="_blank" style="color:#92400e;font-weight:bold;">Render ‚Üí Environment Variables ‚Üí Save Changes</a>.
            Le serveur red√©marre (~2 min) et le statut passe au vert.
        </div>

        <div class="platform-grid">
            <!-- Facebook -->
            <div class="platform-card">
                <div class="platform-header">
                    <span class="platform-icon">üìò</span>
                    <span class="platform-name">Facebook</span>
                </div>
                <span class="status-badge <%= platforms.facebook?.connected ? 'connected' : 'disconnected' %>" id="status-facebook">
                    <span class="dot"></span>
                    <%= platforms.facebook?.connected ? 'Connect√©' : 'Non connect√©' %>
                </span>
                <div class="platform-info" id="info-facebook">
                    <%= platforms.facebook?.connected ? platforms.facebook.name || '' : platforms.facebook?.reason || 'Token expir√©' %>
                </div>
                <button class="platform-btn <%= platforms.facebook?.connected ? 'connected' : 'connect' %>" 
                        onclick="connectPlatform('facebook')" id="btn-facebook">
                    <%= platforms.facebook?.connected ? '‚úì Connect√©' : 'üîó Connecter' %>
                </button>
            </div>

            <!-- Instagram -->
            <div class="platform-card">
                <div class="platform-header">
                    <span class="platform-icon">üì∑</span>
                    <span class="platform-name">Instagram</span>
                </div>
                <span class="status-badge <%= platforms.instagram?.connected ? 'connected' : 'disconnected' %>" id="status-instagram">
                    <span class="dot"></span>
                    <%= platforms.instagram?.connected ? 'Connect√©' : 'Non connect√©' %>
                </span>
                <div class="platform-info" id="info-instagram">
                    <%= platforms.instagram?.connected ? platforms.instagram.username || '' : platforms.instagram?.reason || 'Utilise le m√™me token que Facebook' %>
                </div>
                <button class="platform-btn <%= platforms.instagram?.connected ? 'connected' : 'connect' %>" 
                        onclick="connectPlatform('facebook')" id="btn-instagram">
                    <%= platforms.instagram?.connected ? '‚úì Connect√©' : 'üîó Via Facebook' %>
                </button>
            </div>

            <!-- Twitter -->
            <div class="platform-card">
                <div class="platform-header">
                    <span class="platform-icon">üê¶</span>
                    <span class="platform-name">Twitter / X</span>
                </div>
                <span class="status-badge <%= platforms.twitter?.connected ? 'connected' : 'disconnected' %>" id="status-twitter">
                    <span class="dot"></span>
                    <%= platforms.twitter?.connected ? 'Connect√©' : 'Non connect√©' %>
                </span>
                <div class="platform-info" id="info-twitter">
                    <% if (platforms.twitter?.connected) { %>
                        @<%= platforms.twitter.username || '' %>
                    <% } else { %>
                        Tokens manuels ‚Äî va sur
                        <a href="https://developer.twitter.com/en/portal/projects-and-apps" target="_blank" style="color:#6366f1;">developer.twitter.com</a>
                        ‚Üí ton app ‚Üí Keys and Tokens ‚Üí copie
                        <strong>Access Token</strong> &amp; <strong>Access Token Secret</strong>
                        dans Render (<code>TWITTER_ACCESS_TOKEN</code>, <code>TWITTER_ACCESS_TOKEN_SECRET</code>).
                    <% } %>
                </div>
                <button class="platform-btn <%= platforms.twitter?.connected ? 'connected' : 'disabled' %>"
                        id="btn-twitter" disabled>
                    <%= platforms.twitter?.connected ? '‚úì Connect√©' : 'üîë Tokens manuels (voir ci-dessus)' %>
                </button>
            </div>

            <!-- LinkedIn -->
            <div class="platform-card">
                <div class="platform-header">
                    <span class="platform-icon">üíº</span>
                    <span class="platform-name">LinkedIn</span>
                </div>
                <span class="status-badge <%= platforms.linkedin?.connected ? 'connected' : 'disconnected' %>" id="status-linkedin">
                    <span class="dot"></span>
                    <%= platforms.linkedin?.connected ? 'Connect√©' : 'Non connect√©' %>
                </span>
                <div class="platform-info" id="info-linkedin">
                    <%= platforms.linkedin?.connected ? platforms.linkedin.name || '' : platforms.linkedin?.reason || 'Token expire apr√®s 60 jours' %>
                </div>
                <button class="platform-btn <%= platforms.linkedin?.connected ? 'connected' : 'connect' %>" 
                        onclick="connectPlatform('linkedin')" id="btn-linkedin">
                    <%= platforms.linkedin?.connected ? '‚úì Connect√©' : 'üîó Connecter' %>
                </button>
            </div>

            <!-- TikTok -->
            <div class="platform-card">
                <div class="platform-header">
                    <span class="platform-icon">üéµ</span>
                    <span class="platform-name">TikTok</span>
                </div>
                <span class="status-badge <%= platforms.tiktok?.connected ? 'connected' : 'disconnected' %>" id="status-tiktok">
                    <span class="dot"></span>
                    <%= platforms.tiktok?.connected ? 'Connect√©' : 'Non connect√©' %>
                </span>
                <div class="platform-info" id="info-tiktok">
                    <% if (platforms.tiktok?.connected) { %>
                        <%= platforms.tiktok.username || '' %>
                    <% } else { %>
                        <%= platforms.tiktok?.reason || '' %><br>
                        <small style="color:#f59e0b;">‚ö†Ô∏è App en Sandbox ‚Äî publication limit√©e aux comptes de test. Pour publier publiquement, soumettre l'app en Production sur <a href="https://developers.tiktok.com/apps" target="_blank" style="color:#6366f1;">developers.tiktok.com</a>.</small>
                    <% } %>
                </div>
                <button class="platform-btn <%= platforms.tiktok?.connected ? 'connected' : 'connect' %>" 
                        onclick="connectPlatform('tiktok')" id="btn-tiktok">
                    <%= platforms.tiktok?.connected ? '‚úì Connect√©' : 'üîó Connecter (Sandbox)' %>
                </button>
            </div>

            <!-- YouTube -->
            <div class="platform-card">
                <div class="platform-header">
                    <span class="platform-icon">üì∫</span>
                    <span class="platform-name">YouTube</span>
                </div>
                <span class="status-badge <%= platforms.youtube?.connected ? 'connected' : 'disconnected' %>" id="status-youtube">
                    <span class="dot"></span>
                    <%= platforms.youtube?.connected ? 'Connect√©' : 'Non connect√©' %>
                </span>
                <div class="platform-info" id="info-youtube">
                    <%= platforms.youtube?.connected ? platforms.youtube.channelTitle || '' : platforms.youtube?.reason || 'Refresh token invalide' %>
                </div>
                <button class="platform-btn <%= platforms.youtube?.connected ? 'connected' : 'connect' %>" 
                        onclick="connectPlatform('youtube')" id="btn-youtube">
                    <%= platforms.youtube?.connected ? '‚úì Connect√©' : 'üîó Connecter' %>
                </button>
            </div>
        </div>

        <div class="instructions">
            <h2>üìã Instructions importantes</h2>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Configuration requise</strong>
                <p>Avant de continuer, assurez-vous d'avoir configur√© les URLs de redirection dans chaque plateforme:</p>
            </div>

            <div class="instruction-item">
                <strong>LinkedIn - Redirect URLs</strong>
                <a href="https://www.linkedin.com/developers/apps" target="_blank">LinkedIn Developers</a> ‚Üí App ‚Üí Auth ‚Üí Authorized redirect URLs:<br>
                <code>https://spread.onlymatt.ca/auth/linkedin/callback</code><br>
                <code>https://spread-it-enhanced.onrender.com/auth/linkedin/callback</code>
            </div>

            <div class="instruction-item">
                <strong>Facebook - Redirect URLs</strong>
                <a href="https://developers.facebook.com/apps" target="_blank">Facebook Developers</a> ‚Üí App ‚Üí Facebook Login ‚Üí Settings:<br>
                <code>https://spread.onlymatt.ca/auth/facebook/callback</code><br>
                <code>https://spread-it-enhanced.onrender.com/auth/facebook/callback</code>
            </div>

            <div class="instruction-item">
                <strong>YouTube - Redirect URLs</strong>
                <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a> ‚Üí Credentials ‚Üí OAuth 2.0 Client ‚Üí Authorized redirect URIs:<br>
                <code>https://spread.onlymatt.ca/auth/youtube/callback</code><br>
                <code>https://spread-it-enhanced.onrender.com/auth/youtube/callback</code>
            </div>

            <div class="instruction-item">
                <strong>TikTok - Redirect URI + Production Mode</strong>
                <a href="https://developers.tiktok.com/apps" target="_blank">TikTok Developers</a> ‚Üí App ‚Üí Redirect URI:<br>
                <code>https://spread.onlymatt.ca/auth/tiktok/callback</code><br>
                <code>https://spread-it-enhanced.onrender.com/auth/tiktok/callback</code><br>
                <small>Pour publier publiquement, soumettre une demande de passage en Production Mode.</small>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshStatus()" id="refresh-btn" title="Actualiser les statuts">
        üîÑ
    </button>

    <script>
        async function connectPlatform(platform) {
            const btn = document.getElementById(`btn-${platform}`);
            btn.textContent = '‚è≥ Connexion...';
            btn.disabled = true;

            try {
                // Open OAuth popup
                const width = 600;
                const height = 700;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                const authWindow = window.open(
                    `/auth/${platform}/start`,
                    'oauth',
                    `width=${width},height=${height},left=${left},top=${top}`
                );

                // Poll for popup close
                const pollTimer = setInterval(() => {
                    if (authWindow.closed) {
                        clearInterval(pollTimer);
                        setTimeout(() => {
                            refreshStatus();
                        }, 1000);
                    }
                }, 500);

            } catch (error) {
                console.error('Auth error:', error);
                alert('Erreur de connexion. V√©rifiez la console.');
                btn.textContent = 'üîó Connecter';
                btn.disabled = false;
            }
        }

        async function refreshStatus() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('loading');

            try {
                const response = await fetch('/api/platforms/status');
                const statuses = await response.json();

                // Update each platform
                Object.keys(statuses).forEach(platform => {
                    const status = statuses[platform];
                    const badge = document.getElementById(`status-${platform}`);
                    const info = document.getElementById(`info-${platform}`);
                    const btn = document.getElementById(`btn-${platform}`);

                    if (!badge || !info || !btn) return;

                    if (status.connected) {
                        badge.className = 'status-badge connected';
                        badge.innerHTML = '<span class="dot"></span>Connect√©';
                        info.textContent = status.username || status.name || status.channelTitle || '';
                        btn.className = 'platform-btn connected';
                        btn.textContent = '‚úì Connect√©';
                    } else {
                        badge.className = 'status-badge disconnected';
                        badge.innerHTML = '<span class="dot"></span>Non connect√©';
                        info.textContent = status.reason || '';
                        
                        if (platform !== 'twitter') {
                            btn.className = 'platform-btn connect';
                            btn.textContent = 'üîó Connecter';
                            btn.disabled = false;
                        }
                    }
                });

                console.log('‚úÖ Statuts mis √† jour');
            } catch (error) {
                console.error('Error refreshing status:', error);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshStatus, 30000);

        // Listen for messages from popup
        window.addEventListener('message', (event) => {
            if (event.data.type === 'oauth-success') {
                console.log('OAuth success:', event.data.platform);
                setTimeout(refreshStatus, 1000);
            }
        });
    </script>
</body>
</html>
