<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spread It - Smart Share</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            overflow-y: auto;
        }
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Left Sidebar - Source Content & Platform Select */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            z-index: 10;
        }
        
        .source-preview-img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            object-fit: cover;
            max-height: 250px;
        }

        .platform-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: #333;
        }
        .platform-btn:hover {
            background: #f0f2ff;
            transform: translateX(5px);
        }
        .platform-btn.active {
            background: #e7f3ff;
            border-color: #1877f2;
            color: #1877f2;
            font-weight: 600;
        }
        .platform-btn i {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        /* Right Content - The "Real" Editor */
        .editor-area {
            flex: 1;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            position: relative;
        }

        /* Platform Specific Mockups */
        .mockup {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            max-height: calc(100vh - 180px);
            overflow: auto;
            display: none; /* Hidden by default */
        }
        .mockup.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Facebook Style */
        .fb-mockup {
            border: 1px solid #ddd;
        }
        .fb-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fcfcfc;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
        }
        .fb-avatar {
            width: 40px;
            height: 40px;
            background: #ddd;
            border-radius: 50%;
            margin-right: 10px;
        }
        .fb-body {
            padding: 0;
        }
        .fb-textarea {
            width: 100%;
            border: none;
            padding: 20px;
            font-size: 24px;
            resize: none; /* auto-resized via JS */
            outline: none;
            min-height: 150px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .fb-media {
            padding: 0 15px 15px;
        }
        .fb-media img {
            width: 100%;
            border-radius: 8px;
        }
        .fb-footer {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .fb-btn {
            background: #1877f2;
            color: white;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Instagram Style */
        .ig-mockup {
            max-width: 400px;
            border: 1px solid #dbdbdb;
        }
        .ig-header {
            padding: 14px 16px;
            border-bottom: 1px solid #dbdbdb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ig-preview-img {
            width: 100%;
            display: block;
        }
        .ig-body {
            padding: 16px;
        }
        .ig-textarea {
            width: 100%;
            border: none;
            resize: none; /* auto-resized via JS */
            outline: none;
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 18px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Twitter Style */
        .tw-mockup {
            border-radius: 16px;
        }
        .tw-body {
            padding: 16px;
            display: flex;
        }
        .tw-input-area {
            flex: 1;
            margin-left: 12px;
        }
        .tw-textarea {
            width: 100%;
            border: none;
            font-size: 20px;
            resize: none; /* auto-resized via JS */
            outline: none;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .tw-btn {
            background: #1d9bf0;
            color: white;
            border: none;
            border-radius: 9999px;
            padding: 8px 16px;
            font-weight: 700;
            float: right;
        }

        /* AI Overlay */
        .ai-assistant {
            margin-top: 15px;
            background: #f0f7ff;
            border: 1px dashed #1877f2;
            padding: 15px;
            border-radius: 8px;
        }
        .ai-btn {
            font-size: 0.9rem;
            color: #1877f2;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Spread It Pulse */
        .spread-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        .hidden-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive tweaks */
        @media (max-width: 992px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
            .editor-area { padding: 20px; }
            .mockup { max-width: 100%; max-height: calc(100vh - 260px); }
        }
        @media (max-width: 576px) {
            .fb-textarea { font-size: 18px; padding: 16px; }
            .tw-textarea { font-size: 18px; }
            .ig-textarea { font-size: 13px; }
        }

        /* Env alert banner */
        .env-alert {
            position: sticky;
            top: 0;
            z-index: 110;
            margin: 0;
            border-radius: 0;
        }
    </style>
</head>
<body>

<div class="main-container">

    <!-- Sidebar: Logo & Platforms -->
    <div class="sidebar">
        <div class="text-center mb-4">
            <h3 style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;">
                <i class="fas fa-rocket"></i> Spread It
            </h3>
        </div>

        <% 
            let sourceIsEmbed = true; // Default to embed (iframe) for unknown video sources
            if (data.video) {
                // Only treat as native raw video if it explicitly ends in a video extension
                const v = data.video.toLowerCase().split('?')[0]; // Ignore query params
                if (v.endsWith('.mp4') || v.endsWith('.webm') || v.endsWith('.ogg') || v.endsWith('.mov') || v.endsWith('.m4v')) {
                    sourceIsEmbed = false;
                }
            }
        %>

        <h6>Source Detected</h6>
        <% if (data.video) { %>
            <% if (sourceIsEmbed) { %>
                <iframe src="<%= data.video %>" class="source-preview-img" style="height: 250px; border:none;" allowfullscreen></iframe>
            <% } else { %>
                <video src="<%= data.video %>" class="source-preview-img" controls style="max-height: 250px; background:black;"></video>
            <% } %>
        <% } else if (data.image) { %>
            <img src="<%= data.image %>" class="source-preview-img" alt="Captured content">
        <% } %>
        <p class="small text-muted mb-4"><i class="fas fa-link"></i> <%= data.title %></p>

        <h6>Select Platform</h6>
        <div class="platform-btn" onclick="selectPlatform('facebook')">
            <i class="fab fa-facebook text-primary"></i> Facebook
        </div>
        <div class="platform-btn" onclick="selectPlatform('instagram')">
            <i class="fab fa-instagram" style="color: #e1306c;"></i> Instagram
        </div>
        <div class="platform-btn" onclick="selectPlatform('twitter')">
            <i class="fab fa-twitter text-info"></i> Twitter / X
        </div>
        <div class="platform-btn" onclick="selectPlatform('linkedin')">
            <i class="fab fa-linkedin text-primary"></i> LinkedIn
        </div>
    </div>

    <!-- Editor Area -->
    <div class="editor-area" id="editorArea">
        
        <div id="placeholder" class="hidden-placeholder">
            <i class="fas fa-hand-pointer fa-3x mb-3"></i>
            <h4>Select a platform to start spreading</h4>
            <p>Customize your post for each network individually.</p>
        </div>

        <!-- Facebook Mockup -->
        <div id="facebook-mockup" class="mockup fb-mockup">
            <div class="fb-header">
                <div class="fb-avatar"></div>
                <div><strong>Your Page</strong><div class="small">Public</div></div>
            </div>
            <textarea class="fb-textarea" placeholder="What's on your mind?"><%= data.text %></textarea>
            <div class="fb-media">
                <% if (data.video) { %>
                    <% 
                       var isEmbed = true; // Default to embed
                       try {
                           if (data.video) {
                               const v = data.video.toLowerCase().split('?')[0];
                               if (v.endsWith('.mp4') || v.endsWith('.webm') || v.endsWith('.ogg') || v.endsWith('.mov') || v.endsWith('.m4v')) {
                                   isEmbed = false;
                               }
                           }
                       } catch (e) {} 
                    %>
                    <% if (isEmbed) { %>
                        <iframe src="<%= data.video %>" style="width:100%; height:300px; border:none; border-radius:8px;" allowfullscreen></iframe>
                    <% } else { %>
                        <video src="<%= data.video %>" controls style="width:100%; border-radius:8px;"></video>
                    <% } %>
                <% } else { %>
                    <img src="<%= data.image %>" alt="">
                <% } %>
            </div>
            
            <div class="ai-assistant">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small><strong><i class="fas fa-robot"></i> AI Assistant</strong></small>
                    <span class="ai-btn" onclick="enhanceText('facebook')">Enhance Text</span>
                </div>
                <small class="text-muted">Suggestions based on image content...</small>
            </div>

            <div class="fb-footer">
                <button class="fb-btn spread-pulse" onclick="spreadIt('facebook')">Spread It to Facebook</button>
            </div>
        </div>

        <!-- Instagram Mockup -->
        <div id="instagram-mockup" class="mockup ig-mockup">
            <div class="ig-header">
                <span class="text-muted">Create new post</span>
                <span class="text-primary fw-bold" onclick="spreadIt('instagram')">Share</span>
            </div>
            <% if (data.video) { %>
                <video src="<%= data.video %>" class="ig-preview-img" controls></video>
            <% } else { %>
                <img src="<%= data.image %>" class="ig-preview-img" alt="">
            <% } %>

            <div class="ig-body">
                <textarea class="ig-textarea" rows="4" placeholder="Write a caption..."><%= data.text %></textarea>
                <div class="ai-assistant mt-3">
                    <span class="ai-btn" onclick="enhanceText('instagram')">Generate Hashtags</span>
                </div>
            </div>
        </div>

         <!-- Twitter Mockup -->
         <div id="twitter-mockup" class="mockup tw-mockup">
            <div class="p-3 border-bottom">
                <button class="tw-btn spread-pulse" onclick="spreadIt('twitter')">Post</button>
                <div style="clear:both"></div>
            </div>
            <div class="tw-body">
                <div class="fb-avatar" style="width:48px;height:48px;"></div>
                <div class="tw-input-area">
                    <textarea class="tw-textarea" rows="3" placeholder="What is happening?"><%= data.text %></textarea>
                    <% if (data.video) { %>
                        <video src="<%= data.video %>" controls style="width:100%; border-radius:16px; border:1px solid #eee;"></video>
                    <% } else { %>
                        <img src="<%= data.image %>" style="width:100%; border-radius:16px; border:1px solid #eee;" alt="">
                    <% } %>
                    
                    <div class="ai-assistant mt-3">
                        <span class="ai-btn" onclick="enhanceText('twitter')">Shorten & Optimize</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- LinkedIn Mockup (Reusing FB minimal style for now) -->
        <div id="linkedin-mockup" class="mockup fb-mockup">
             <div class="fb-header">
                <div class="fb-avatar"></div>
                <div><strong>Your Profile</strong><div class="small">Posted by user</div></div>
            </div>
            <textarea class="fb-textarea" placeholder="What do you want to talk about?"><%= data.text %></textarea>
             <div class="fb-media">
                <img src="<%= data.image %>" alt="">
            </div>
             <div class="fb-footer">
                <button class="fb-btn spread-pulse" style="background:#0077b5" onclick="spreadIt('linkedin')">Post to LinkedIn</button>
            </div>
        </div>

    </div>
</div>

<script>
// --- Split Composer: Locked + AI-managed ---
function getActivePlatform() {
    const active = document.querySelector('.platform-btn.active');
    if (!active) return 'facebook';
    if (active.innerText.toLowerCase().includes('instagram')) return 'instagram';
    if (active.innerText.toLowerCase().includes('twitter')) return 'twitter';
    if (active.innerText.toLowerCase().includes('linkedin')) return 'linkedin';
    return 'facebook';
}

function applyComposerToActive() {
    const platform = getActivePlatform();
    const container = document.getElementById(platform + '-mockup');
    const textarea = container.querySelector('textarea');
    const locked = document.getElementById('locked-textarea')?.value || '';
    const ai = document.getElementById('ai-textarea')?.value || '';
    const sep = locked && ai ? "\n\n" : '';
    const merged = locked + sep + ai;
    textarea.value = formatForPlatformPreview(platform, merged);
    autoResize(textarea);
}

async function aiEditFromChat() {
    const platform = getActivePlatform();
    const input = document.getElementById('ai-chat-input');
    const log = document.getElementById('ai-chat-log');
    const instruction = (input.value || '').trim();
    if (!instruction) return;

    const locked = document.getElementById('locked-textarea')?.value || '';
    const aiText = document.getElementById('ai-textarea')?.value || '';

    // Append user message
    const userBubble = document.createElement('div');
    userBubble.className = 'chat-msg user';
    userBubble.textContent = instruction;
    log.appendChild(userBubble);
    input.value = '';

    try {
        const res = await fetch('/api/ai-edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ platform, instruction, lockedText: locked, aiText })
        });
        const data = await res.json();
        const newText = data?.edited || aiText;
        document.getElementById('ai-textarea').value = newText;

        const aiBubble = document.createElement('div');
        aiBubble.className = 'chat-msg ai';
        aiBubble.textContent = newText;
        log.appendChild(aiBubble);

        applyComposerToActive();
        log.scrollTop = log.scrollHeight;
    } catch (e) {
        console.error(e);
    }
}
function selectPlatform(platform) {
    // UI Updates
    document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.platform-btn[onclick*="${platform}"]`).classList.add('active');

    document.getElementById('placeholder').style.display = 'none';
    document.querySelectorAll('.mockup').forEach(m => m.classList.remove('active'));
    
    document.getElementById(platform + '-mockup').classList.add('active');
    const ta = document.getElementById(platform + '-mockup').querySelector('textarea');
    if (ta) autoResize(ta);
}

function enhanceText(platform) {
   const btn = event.target;
   const originalText = btn.innerText;
   btn.innerText = 'Thinking...';
   
   // Determine intent based on platform (IG = Hashtags only, others = Captions)
   // Or verify button text if we want to be more specific
   let action = 'create_post';
   if (platform === 'instagram') {
       action = 'generate_hashtags';
   }

   // Use current textarea content as base for enhancement
   const container = document.getElementById(platform + '-mockup');
   const textarea = container.querySelector('textarea');
   const currentText = textarea ? textarea.value : "";

   fetch('/api/create-post-ai', {
       method: 'POST',
       headers: {'Content-Type': 'application/json'},
       body: JSON.stringify({
           content: currentText && currentText.trim().length > 0 
                    ? currentText.trim() 
                    : "Context from media: <%= data.title %>",
           options: { 
               platform: platform, 
               style: 'engaging',
               action: action 
           },
           mediaUrl: "<%= data.video || data.image %>",
           mediaType: "<%= data.video ? 'video' : 'image' %>"
       })
   }).then(res => res.json()).then(data => {
       if (action === 'generate_hashtags') {
           // Append hashtags to existing text instead of replacing
           const currentValue = textarea.value;
           textarea.value = currentValue + "\n\n" + (data.content || "#SpreadIt #Viral");
       } else {
           textarea.value = data.content || "AI generated amazing content for " + platform; 
       }
       
       btn.innerText = originalText;
   }).catch(e => {
       console.error(e);
       // Fallback simulation
       if (platform === 'twitter') textarea.value += " #Trending #SpreadIt";
       else if (platform === 'instagram') textarea.value += "\n.\n.\n#InstaGood #DailyInspo";
       else textarea.value += " [Enhanced by AI]";
       btn.innerText = originalText;
   });
}

function spreadIt(platform) {
    const container = document.getElementById(platform + '-mockup');
    const content = container.querySelector('textarea').value;
    const btn = container.querySelector('button') || container.querySelector('.text-primary'); // For IG
    
    if (!btn) return;

    const originalText = btn.innerText;
    btn.innerText = 'Spreading...';
    btn.style.opacity = '0.7';
    btn.style.pointerEvents = 'none';
    
    // payload
    const payload = {
        mediaUrl: "<%= data.video || data.image %>",
        mediaType: "<%= data.video ? 'video' : 'image' %>",
        caption: content,
        platforms: [platform], 
        hashtags: []
    };

    // Actual API Call
    fetch('/api/smart-share-submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';

        if (data.success) {
            btn.innerText = 'Published!';
            alert("✅ Successfully published to " + platform + "!");
        } else {
            console.error(data.errors);
            btn.innerText = 'Failed';
            let msg = data.message;
            if (data.errors && data.errors.length > 0) {
                msg += "\n\nErrors:\n" + data.errors.map(e => `- ${e.platform}: ${e.error}`).join('\n');
            }
            alert("⚠️ " + msg);
            // Revert text after a delay so they can try again
            setTimeout(() => btn.innerText = originalText, 3000);
        }
    })
    .catch(err => {
        console.error("Fetch error:", err);
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
        btn.innerText = 'Error';
        alert("❌ Network/Server Error: " + err.message);
    });
}

// Minimal UI injection: composer + chat (kept simple for now)
document.addEventListener('DOMContentLoaded', () => {
    const host = document.querySelector('.container') || document.body;

    // Insert env warnings placeholder
    const envAlert = document.createElement('div');
    envAlert.id = 'env-alert';
    envAlert.style.display = 'none';
    envAlert.className = 'alert alert-warning env-alert';
    host.prepend(envAlert);
    const composer = document.createElement('div');
    composer.className = 'composer-wrapper';
    composer.style.position = 'sticky';
    composer.style.top = '0';
    composer.style.zIndex = '100';
    composer.style.background = '#fff';
    composer.style.borderBottom = '1px solid #eee';
    composer.style.boxShadow = '0 2px 6px rgba(0,0,0,0.04)';
    composer.innerHTML = `
    <div style="display:flex; gap:16px; margin:8px 0; align-items:flex-start; flex-wrap:wrap; padding:12px">
        <div style="flex:1; min-width:280px">
            <label style="font-weight:600">Locked (reste tel quel)</label>
            <textarea id="locked-textarea" placeholder="Ex: @nom, #hashtags obligatoires, mentions, clauses…" style="width:100%; min-height:80px"></textarea>
            <label style="font-weight:600; margin-top:8px; display:block">AI section (modifiable)</label>
            <textarea id="ai-textarea" placeholder="Texte géré par l'IA" style="width:100%; min-height:120px"></textarea>
            <div style="margin-top:8px">
                <button class="btn btn-sm btn-primary" onclick="applyComposerToActive()">Appliquer au post actif</button>
            </div>
        </div>
        <div style="flex:1; min-width:280px">
            <label style="font-weight:600">Chat IA (éditer la partie AI)</label>
            <div id="ai-chat-log" style="border:1px solid #ddd; border-radius:8px; padding:8px; height:180px; overflow:auto; background:#fff"></div>
            <div style="display:flex; gap:8px; margin-top:8px">
                <input id="ai-chat-input" type="text" placeholder="Ex: Rends ça plus punchy, ajoute 2 emojis, garde mes hashtags" style="flex:1; padding:8px">
                <button class="btn btn-sm" onclick="aiEditFromChat()">Envoyer</button>
            </div>
        </div>
    </div>`;
    host.prepend(composer);

    // Auto-resize for all textareas
    document.querySelectorAll('textarea').forEach(autoResize);
    document.querySelectorAll('textarea').forEach(el => {
        el.addEventListener('input', () => autoResize(el));
    });

        // Fetch env health and show banner if needed
        fetch('/health/env')
            .then(r => r.json())
            .then(({ ok, issues }) => {
                if (!ok && Array.isArray(issues) && issues.length) {
                    const alertNode = document.getElementById('env-alert');
                    alertNode.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>Configuration warnings:</strong>
                                <ul style="margin:6px 0 0 18px">
                                    ${issues.slice(0,5).map(i => `<li>${i}</li>`).join('')}
                                </ul>
                                ${issues.length > 5 ? `<small class="text-muted">+ ${issues.length - 5} more…</small>` : ''}
                            </div>
                            <button type="button" class="btn-close" aria-label="Close"></button>
                        </div>`;
                    alertNode.style.display = 'block';
                    const closeBtn = alertNode.querySelector('.btn-close');
                    if (closeBtn) closeBtn.addEventListener('click', () => alertNode.remove());
                }
            })
            .catch(() => {});
});

// Lightweight platform-aware preview formatter (length + hashtag count)
function formatForPlatformPreview(platform, text) {
    let charLimit = 2000;
    let hashtagLimit = Infinity;
    const p = (platform || '').toLowerCase();
    if (p === 'instagram') { charLimit = 2200; hashtagLimit = 30; }
    else if (p === 'twitter') { charLimit = 280; hashtagLimit = 4; }
    else if (p === 'linkedin') { charLimit = 3000; hashtagLimit = 10; }
    else if (p === 'facebook') { charLimit = 2000; hashtagLimit = 20; }

    // Enforce hashtag count by token filtering
    const tokens = (text || '').split(/(\s+)/); // keep spaces
    let seen = 0;
    const filtered = tokens.map(tok => {
        if (/^#\w/.test(tok) || /^#[\p{L}\p{N}_]+/u.test(tok)) {
            if (seen < hashtagLimit) { seen++; return tok; }
            return ''; // drop extra hashtags
        }
        return tok;
    }).join('').replace(/\s{3,}/g, '  ').trim();

    if (filtered.length <= charLimit) return filtered;
    return filtered.slice(0, Math.max(0, charLimit - 1)).trimEnd() + '…';
}

// Auto-resize textareas to fit content up to a sensible max
function autoResize(el) {
    if (!el) return;
    const maxHeight = 400; // px; beyond this, allow scrolling
    el.style.height = 'auto';
    const target = Math.min(el.scrollHeight + 2, maxHeight);
    el.style.height = target + 'px';
    if (el.scrollHeight > maxHeight) {
        el.style.overflowY = 'auto';
    } else {
        el.style.overflowY = 'hidden';
    }
}
</script>

</body>
</html>